
@{
    ViewBag.Title = "OfferApplication";
}

<div class="form-group">
    <div class="col-md-6">
        <input type="text" class="form-control" id="txt-offer-code" style="width: 100%" />
    </div>
    <div class="col-md-2">
        <input type="button" id="btn-check-offer-code" class="btn btn-default form-control" value="Kiểm tra" />
    </div>
</div>

<div id="txt-err-msg" style="color: red; display: none; margin-top: 50px;"></div>
<div class="form-group" style="margin-top: 50px; display: none;" id="group-info">
    <dl class="dl-horizontal">
        <dt>
            Giảm:
        </dt>
        <dd id="percent">
            
        </dd>
    </dl>
    <div class="text-center" style="width: 30%;">
        <input id="btn-apply" type="button" class="btn btn-primary" value="Áp dụng" />
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#btn-apply').on('click', function () {
                applySaleCode()
            });
            $('#btn-check-offer-code').on('click', function () {
                if ($('#txt-offer-code').val().trim() == '') {
                    $('#txt-err-msg').html('Hãy nhập mã giảm giá!');
                    $('#txt-err-msg').show();
                    $('#group-info').hide();
                }
                else {
                    checkSaleCode();
                }          
            });
        });

        function checkSaleCode() {
            $.ajax({
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                url: '@Url.Action("CheckOfferCode", "Offer")',
                data: JSON.stringify({ code: $('#txt-offer-code').val() }),
                beforeSend: function () {
                    $('.loading').show();
                },
                success: function (response) {
                    if (response.IsSuccessful == 1) {
                        $('#percent').html(response.Percent + '%');

                        $('#txt-err-msg').hide();
                        $('#group-info').show();
                    }
                    else {
                        $('#txt-err-msg').html(response.Msg);
                        $('#txt-err-msg').show();
                        $('#group-info').hide();
                    }
                },
                error: function (error) {
                    $('#txt-err-msg').html("Đã xảy ra lỗi không xác định!");
                    $('#txt-err-msg').show();
                    $('#group-info').hide();
                },
                complete: function () {
                    $('.loading').hide();
                }
            });
        }

        function applySaleCode() {
            $.ajax({
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                url: '@Url.Action("ApplySaleCode", "Offer")',
                data: JSON.stringify({ code: $('#txt-offer-code').val() }),
                beforeSend: function () {
                    $('.loading').show();
                },
                success: function (response) {
                    if (response.IsSuccessful == 1) {
                        alert('Đã áp dụng mã giảm giá ' + $('#txt-offer-code').val());
                        $('#txt-offer-code').val('');
                    }
                    else {
                        alert('Đã xảy ra lỗi không xác định!');
                    }
                },
                error: function (error) {
                    alert('Đã xảy ra lỗi không xác định!');
                },
                complete: function () {
                    $('.loading').hide();
                    $('#txt-err-msg').hide();
                    $('#group-info').hide();
                }
            });
        }
    </script>
}